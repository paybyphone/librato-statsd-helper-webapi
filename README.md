# librato-statsd-helper-webapi

[![NuGet](https://img.shields.io/nuget/v/librato-statsd-helper-webapi.svg)]()

Filter attributes to allow easy metrics gathering based on Response Codes.

See https://github.com/paybyphone/statsd-helper configuring the statsd-helper itself.

Along with the prefix generated by the statsd-helper, the metric will attach additional information about the request (e.g. action name, controller name, status code) as
Librato-flavoured tags to the outgoing metric.

For example:
```
com.example.servername.api.requests#action=validate,http_status=404
```

You can also choose to return the latency of the request in the response headers:

```
X-ExecutionTime : 123ms
```

This is configurable by using the `StatsD.WebApi.Response.LatencyHeader.Enabled` appSetting. By default this is disabled.

```xml
<add key="StatsD.WebApi.Response.LatencyHeader.Enabled" value="true" />
```

## Librato Tags

`librato-statsd-helper-webapi` makes use of Librato's tagged-metric features and will send the additional metadata as tagged values along with the base metric. If you do not have
a Librato account which has tagged-metrics enabled, or are forwarding to a different system or integration, then you should use the non-librato specific https://github.com/paybyphone/statsd-helper-webapi.

## Usage

Add the `InstrumentActionMessageHandler` into your WebAPI pipeline

```csharp
    public static class WebApiConfig
    {
        public static void Register(HttpConfiguration config)
        {
            ...
            config.ConfigureInstrumentFilters();
            ...
        }

        private static void ConfigureInstrumentFilters(this HttpConfiguration config)
        {
            config.MessageHandlers.Add(new InstrumentActionMessageHandler());
        }
    }
```

Response instrumentation in the message handler will run after all controller logic and exception filters.

This means that metrics will be generated based on the contents/properties of the response after any controller level exception handling or modification has taken place.

If you want to instrument only specific actions, then the `InstrumentStatusCodeFilterAttribute` can be used instead.

```csharp
    public class ApiController
    {
        [InstrumentStatusCodeFilter]
        public void ApiAction()
        {
        }
    }
```
